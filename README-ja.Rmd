---
format: gfm
---

<!-- README-ja.md is generated from README-ja.Rmd. Do not edit README-ja.md directly. -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "50%"
)
options(width=400)
```

# totalize

<!-- badges: start -->
<!-- badges: end -->

集計表を作成し、小計・合計を計算するパッケージ

## インストール

次のコマンドでGitHubからインストールできます。

``` r
devtools::install_github("ichiromurata/totalize")
```

## TL;DR

![](example.png)

## 概要

Rにはデータを集計する様々な関数があります。

`datasets::CO2`のデータを例に取りましょう。データ数のカウントは`table()`で行えます。

```{r}
table(interaction(datasets::CO2$Type, datasets::CO2$Treatment))
```

値の足し上げには`tapply()`、`stats::xtabs()`、

```{r}
tapply(datasets::CO2$uptake, datasets::CO2[c("Type", "Treatment")], FUN=sum)

stats::xtabs(uptake~Type+Treatment, data=datasets::CO2)
```

あるいは`stats::aggregate()`を使うことができます。

```{r}
stats::aggregate(datasets::CO2["uptake"], datasets::CO2[c("Type", "Treatment")], sum)
```

しかしこれらの関数は各グループの小計や合計（上の例では"Type"計、"Treatment"計、合計）までを一度に算出することはできません。
そのような異なる階層の計算を行うには、別々に関数を実行する必要があります。

`totalize`はこれをまとめて一度に行います。

```{r}
library(totalize)
totalize(datasets::CO2, c(Type, Treatment), val=uptake, asDF=TRUE)
```

さらに、2次元の集計表に展開することができます。

```{r}
totalize(datasets::CO2, row=Type, col=Treatment, val=uptake)
```

3つ以上の変数があるときは、行あるいは列に組み合わせを作って2次元の集計表を作成します。

```{r}
totalize(datasets::CO2, row=Type, col=c(Treatment, conc), val=uptake)

totalize(datasets::CO2, row=c(Type, conc), col=Treatment, val=uptake)
```

集計する際に`NA`を無視するには、`na.rm=TRUE`などを`FUN`で指定する関数の引数に追加できます。

```{r}
# Missing values turn the totals into NA
totalize(datasets::penguins, species, island, val=body_mass, FUN=sum)

# Ignoring NAs
totalize(datasets::penguins, species, island, val=body_mass, FUN=sum, na.rm=TRUE)
```

## 分類不詳の扱い

データによってはグループ変数の値に不詳（欠測）を含む場合があります。これを集計するときは「不詳」や「分類不能」として明示的に集計表に示すこともありますが、集計表には表示しないこともしばしばあります。

このような場合に小計や合計を計算するには注意が必要です。グループごとに集計した結果を内訳として足し上げるだけでは、小計や合計から不詳のデータが除かれてしまいます。`totalize`はこれに対処するために小計や合計を全てのデータから計算しています。

下の例では[palmerpenguins](https://allisonhorst.github.io/palmerpenguins/)のデータセットの`sex`列に不詳（`NA`）が含まれることから、femaleとmaleの計が小計と一致しないことを示しています。

```{r}
# Correctly count the total that does not match the sum of female + male
totalize(datasets::penguins, species, sex)

# `addmargins()` excludes the unclassified data
xtabs(~species+sex, data=datasets::penguins) |>
  addmargins()
```

## 1行（1列）のみの表

`totailze`は1列のみの表も作成できます。

```{r}
totalize(datasets::CO2, row=c(Type, Treatment), val=uptake)
```

1行のみの表を作る場合は、上の表を転置`t()`してください。

```{r}
totalize(datasets::CO2, row=c(Type, Treatment), val=uptake) |> t()
```

## Non standard evaluation (NSE)

変数の名前はダブルクォーテーションで囲まずにそのまま渡すことができます。（Non-standard evaluation）

# 四捨五入について

このパッケージでは四捨五入を行う関数`awayfromzero()`を提供しています。

Rの`round()`関数は四捨五入ではなく偶数丸めを行います。四捨五入の関数はbase Rには含まれていません。

`awayfromzero()`は浮動小数点形式の有効桁数の問題に対処するため、入力された数の桁数に応じて切り上げと切り下げを判定する精度を変化させています。

四捨五入はパイプ演算子`|>`で結んで実行できます。

```{r}
totalize(datasets::CO2, row=c(Treatment, conc), col=Type, val=uptake, FUN=mean) |>
    awayfromzero(digits = 1)
```


